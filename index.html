<style>
    body {
        padding: 0;
        margin: 0;
        overflow: hidden;
    }

    .notes {
        margin-top: -10vh;
    }

    .bar {
        height: 0px;
        width: 100vw;
        border-top: 3px solid gray;
        margin-top: calc(20vh - 5px);
    }

    .note {
        position: absolute;
        bottom: 48vh;
        height: 25vh;
    }

    #debug {
        color: red;
        font-weight: bold;
        position: absolute;
        top: 10px;
        left: 20px;
    }

    .measureBar {
        position: absolute;
        width: 1px;
        height: 100vh;
        top: 0px;
        border-left: 3px solid gray;
    }

    #progress {
        position: absolute;
        left: 0px;
        top: 0px;
        height: 100vh;
        background: #00ff0055;
        z-index: 20;
    }
</style>

<body>
    <div id="progress">
        
    </div>

    <div class="notes">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <div class=playbar></div>

    <script>
    // audio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext || window.audioContext);
    

    // settings
    const scrollSpeed = 1.5;
    const bpm = 100; 
    const fps = 60;
    
    // debug values
    let noteCount = 0;
    let entityCount = 0;
    let busySpawning = false;
    let debugValue = null;

    // calculated
    const framesPerBeat = fps / (bpm / 60);
    
    const notePossibilities = [
        {
            name: "quater",
            duration: 0.25,
            width: 0.8
        },

        {
            name: "half",
            duration: 0.5,
            width: 0.8
        },

        {
            name: "doubleEight",
            duration: 0.25,
            width: 1
        },

        {
            name: "quadSixteenth",
            duration: 0.25,
            width: 1
        },

        {
            name: "14quadSixteenth",
            duration: 0.25,
            width: 0.8
        },

        {
            name: "123quadSixteenth",
            duration: 0.25,
            width: 1
        },

        {
            name: "124quadSixteenth",
            duration: 0.25,
            width: 1
        },

        {
            name: "134quadSixteenth",
            duration: 0.25,
            width: 1
        },
    ];

    let notes = [];
    let noteIndex = 0;

    function createNote(type, offset=100) {
        type = `notes/${type}Note.png`;
        document.body.innerHTML += `<img src="${type}" class="note" id="note${noteIndex}" style="left: ${offset}vw"/>`;
        noteCount += 1;
        entityCount += 1;

        notes.push(noteIndex++)
    }

    function updateProgress() {
        document.getElementById("progress").style.width = `${progress < 0 ? 0 : progress}vw`;
    }

    function createRandomMeasure() {
        busySpawning = true;
        let measureLeft = 1;

        const notes = [];

        // create measure bar
        document.body.innerHTML += `<div class="measureBar" style="left: 2vw"></div><div class="measureBar" style="left: 98vw"></div>`;
        entityCount += 1;

        // create some notes
        while (measureLeft != 0) {
            const note = notePossibilities[Math.floor(Math.random() * notePossibilities.length)];
            
            if (measureLeft - note.duration >= 0) {
                notes.push(note);
                measureLeft -= note.duration;
            }
        }

        const noteCount = notes.length;
        let position = 4;

        for (note of notes) {
            createNote(note.name, position);
            position += 25 * note.duration * 4;
        }

        busySpawning = false;
    }

    function doBeat() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + ((200 || 500) / 1000));
    }

    // generate initial measure
    createRandomMeasure();

    let progress = -25;
    let currentBeat = 0;

    setInterval(() => {
        // advance the progress
        progress += 100 / framesPerBeat;
        updateProgress();

        // handle the beat
        if (currentBeat === 0 && progress >= 0) {
            currentBeat = 1;
            doBeat();
        } else if (currentBeat === 1 && progress >= 25) {
            currentBeat = 2;
            doBeat();
        } else if (currentBeat === 2 && progress >= 50) {
            currentBeat = 3;
            doBeat();
        } else if (currentBeat === 3 && progress >= 75) {
            currentBeat = 4;
            doBeat();
        }

        // regenerate the measure
        if (progress >= 100) {
            // remove all the notes
            for (note of notes)
                document.getElementById(`note${note}`).remove()
            notes = []
            
            // generate new notes
            createRandomMeasure();

            // reset progress
            progress = -25;
            currentBeat = 0;
        }
    }, fps)
    </script>
</body>

